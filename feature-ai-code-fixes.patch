From f50abaa38bad70a4fc3dc2e160b86d19d4cd9d23 Mon Sep 17 00:00:00 2001
From: Ib4444 <namthip.sris@ku.th>
Date: Sun, 22 Feb 2026 19:50:35 +0700
Subject: [PATCH] fix(ai): complete all pending features for detection, status,
 stats, and notifications

---
 ios/Podfile.lock                              | 36 ++++++++--------
 .../events/presentation/events_screen.dart    |  1 -
 .../history/data/history_repository_impl.dart |  4 +-
 .../data/health_status_provider.dart          | 43 ++++++++++++++++---
 .../data/pose_detection_service.dart          |  4 +-
 pubspec.lock                                  | 16 +++----
 test/pose_detection_service_test.dart         | 27 ++++++++++++
 7 files changed, 95 insertions(+), 36 deletions(-)

diff --git a/ios/Podfile.lock b/ios/Podfile.lock
index 441c7a3..0494fe5 100644
--- a/ios/Podfile.lock
+++ b/ios/Podfile.lock
@@ -1653,12 +1653,12 @@ SPEC CHECKSUMS:
   AppAuth: d4f13a8fe0baf391b2108511793e4b479691fb73
   AppCheckCore: cc8fd0a3a230ddd401f326489c99990b013f0c4f
   BoringSSL-GRPC: dded2a44897e45f28f08ae87a55ee4bcd19bc508
-  cloud_firestore: fdcc87898326e396d6ef6df543acf9b5c2034b95
-  cloud_functions: 8565a870fbdc2b5046cba8183e972484128b6d8d
+  cloud_firestore: 97e42181866db3cba3fe3935895ab779b6acacd6
+  cloud_functions: 614444590e43b7567dc7f57e6027cb15ab4a2c0e
   Firebase: d99ac19b909cd2c548339c2241ecd0d1599ab02e
-  firebase_auth: 50af8366c87bb88c80ebeae62eb60189c7246b9b
-  firebase_core: 995454a784ff288be5689b796deb9e9fa3601818
-  firebase_storage: 1144b3236855c52ff52741b12374862ee84d5a28
+  firebase_auth: 5342db41af2ba5ed32a6177d9e326eecbebda912
+  firebase_core: 99a37263b3c27536063a7b601d9e2a49400a433c
+  firebase_storage: df33afa2324a7c6c444eba802576f1b1ba7a8108
   FirebaseAppCheckInterop: 06fe5a3799278ae4667e6c432edd86b1030fa3df
   FirebaseAuth: a6575e5fbf46b046c58dc211a28a5fbdd8d4c83b
   FirebaseAuthInterop: 7087d7a4ee4bc4de019b2d0c240974ed5d89e2fd
@@ -1672,12 +1672,12 @@ SPEC CHECKSUMS:
   FirebaseSharedSwift: e17c654ef1f1a616b0b33054e663ad1035c8fd40
   FirebaseStorage: 50fc9ee147392943e492467db6b52759b0447037
   Flutter: cabc95a1d2626b1b06e7179b784ebcf0c0cde467
-  flutter_secure_storage_darwin: acdb3f316ed05a3e68f856e0353b133eec373a23
-  gal: baecd024ebfd13c441269ca7404792a7152fde89
-  google_mlkit_commons: a5e4ffae5bc59ea4c7b9025dc72cb6cb79dc1166
-  google_mlkit_object_detection: 6a81b32faf7a9b700bed7a2caa67254818553257
-  google_mlkit_pose_detection: 211eabf55f5ea8d6a9537fdade0a37148fc84d8b
-  google_sign_in_ios: b48bb9af78576358a168361173155596c845f0b9
+  flutter_secure_storage_darwin: 557817588b80e60213cbecb573c45c76b788018d
+  gal: 6a522c75909f1244732d4596d11d6a2f86ff37a5
+  google_mlkit_commons: 1e6ef6605d7281f35baf2b355e6049b9984fd624
+  google_mlkit_object_detection: e41786b13b2e82587cbaeca18758135fe1c6d813
+  google_mlkit_pose_detection: 765dbe5fc48366b3472379f64d891652ed606835
+  google_sign_in_ios: 7411fab6948df90490dc4620ecbcabdc3ca04017
   GoogleDataTransport: aae35b7ea0c09004c3797d53c8c41f66f219d6a7
   GoogleMLKit: b1eee21a41c57704fe72483b15c85cb2c0cd7444
   GoogleSignIn: ce8c89bb9b37fb624b92e7514cc67335d1e277e4
@@ -1687,8 +1687,8 @@ SPEC CHECKSUMS:
   gRPC-Core: 860978b7db482de8b4f5e10677216309b5ff6330
   GTMAppAuth: f69bd07d68cd3b766125f7e072c45d7340dea0de
   GTMSessionFetcher: 5aea5ba6bd522a239e236100971f10cb71b96ab6
-  image_cropper: 5f162dcf988100dc1513f9c6b7eb42cd6fbf9156
-  image_picker_ios: e0ece4aa2a75771a7de3fa735d26d90817041326
+  image_cropper: 37d40f62177c101ff4c164906d259ea2c3aa70cf
+  image_picker_ios: 4f2f91b01abdb52842a8e277617df877e40f905b
   leveldb-library: cc8b8f8e013647a295ad3f8cd2ddf49a6f19be19
   MLImage: 0de5c6c2bf9e93b80ef752e2797f0836f03b58c0
   MLKitCommon: 47d47b50a031d00db62f1b0efe5a1d8b09a3b2e6
@@ -1703,14 +1703,14 @@ SPEC CHECKSUMS:
   MLKitVisionKit: 316cd349468797ef4e7fd785bf658ca838984de3
   MLKitXenoCommon: 1a4268c1222a6043047af5bb9435028206c63287
   nanopb: fad817b59e0457d11a5dfbde799381cd727c1275
-  permission_handler_apple: 4ed2196e43d0651e8ff7ca3483a069d469701f2d
+  permission_handler_apple: 9878588469a2b0d0fc1e048d9f43605f92e6cec2
   PromisesObjC: f5707f49cb48b9636751c5b2e7d227e43fba9f47
   RecaptchaInterop: 11e0b637842dfb48308d242afc3f448062325aba
-  shared_preferences_foundation: 7036424c3d8ec98dfe75ff1667cb0cd531ec82bb
-  sign_in_with_apple: c5dcc141574c8c54d5ac99dd2163c0c72ad22418
+  shared_preferences_foundation: 5086985c1d43c5ba4d5e69a4e8083a389e2909e6
+  sign_in_with_apple: f3bf75217ea4c2c8b91823f225d70230119b8440
   TOCropViewController: 80b8985ad794298fb69d3341de183f33d1853654
-  video_player_avfoundation: dd410b52df6d2466a42d28550e33e4146928280a
+  video_player_avfoundation: 7993f492ae0bd77edaea24d9dc051d8bb2cd7c86
 
 PODFILE CHECKSUM: 2ad212e9f881b64245e16e5295b971a084e8f13d
 
-COCOAPODS: 1.16.2
+COCOAPODS: 1.15.2
diff --git a/lib/src/features/events/presentation/events_screen.dart b/lib/src/features/events/presentation/events_screen.dart
index 5ef4e9d..c32772c 100644
--- a/lib/src/features/events/presentation/events_screen.dart
+++ b/lib/src/features/events/presentation/events_screen.dart
@@ -2,7 +2,6 @@ import 'dart:io';
 import 'package:flutter/material.dart';
 import 'package:flutter_riverpod/flutter_riverpod.dart';
 import 'package:go_router/go_router.dart';
-import '../../pose_detection/data/health_status_provider.dart';
 import '../../dashboard/data/camera_provider.dart';
 import '../../events/data/event_repository.dart';
 import '../../statistics/domain/simulation_event.dart';
diff --git a/lib/src/features/history/data/history_repository_impl.dart b/lib/src/features/history/data/history_repository_impl.dart
index 0f02f2a..0b23529 100644
--- a/lib/src/features/history/data/history_repository_impl.dart
+++ b/lib/src/features/history/data/history_repository_impl.dart
@@ -111,7 +111,9 @@ class HistoryRepositoryImpl implements HistoryRepository {
       }
 
       if (event.isCritical || type == 'falling' || type == 'fall') {
-        falls++;
+        if (event.isVerified == true) {
+          falls++;
+        }
       }
     }
 
diff --git a/lib/src/features/pose_detection/data/health_status_provider.dart b/lib/src/features/pose_detection/data/health_status_provider.dart
index 1a125a3..46e9aae 100644
--- a/lib/src/features/pose_detection/data/health_status_provider.dart
+++ b/lib/src/features/pose_detection/data/health_status_provider.dart
@@ -19,6 +19,7 @@ class HealthState {
   final String currentActivity; // 'standing', 'walking', 'sitting', 'laying', 'falling'
   final List<SimulationEvent> events;
   final Map<String, double> dailyScores; // "YYYY-MM-DD" -> score
+  final bool isVerifying; // AI verification in progress
 
   HealthState ({
     required this.score,
@@ -26,6 +27,7 @@ class HealthState {
     required this.currentActivity,
     required this.events,
     required this.dailyScores,
+    this.isVerifying = false,
   });
 
   factory HealthState.initial() {
@@ -44,6 +46,7 @@ class HealthState {
       currentActivity: 'standing',
       events: [],
       dailyScores: mockScores,
+      isVerifying: false,
     );
   }
 
@@ -53,6 +56,7 @@ class HealthState {
     String? currentActivity,
     List<SimulationEvent>? events,
     Map<String, double>? dailyScores,
+    bool? isVerifying,
   }) {
     return HealthState(
       score: score ?? this.score,
@@ -60,6 +64,7 @@ class HealthState {
       currentActivity: currentActivity ?? this.currentActivity,
       events: events ?? this.events,
       dailyScores: dailyScores ?? this.dailyScores,
+      isVerifying: isVerifying ?? this.isVerifying,
     );
   }
 
@@ -70,6 +75,7 @@ class HealthState {
       'currentActivity': currentActivity,
       'events': events.map((e) => e.toJson()).toList(),
       'dailyScores': dailyScores,
+      'isVerifying': isVerifying,
     };
   }
 
@@ -84,6 +90,7 @@ class HealthState {
       dailyScores: (json['dailyScores'] as Map<String, dynamic>?)?.map(
             (k, v) => MapEntry(k, (v as num).toDouble()),
           ) ?? {},
+      isVerifying: json['isVerifying'] as bool? ?? false,
     );
   }
 }
@@ -163,6 +170,7 @@ class HealthStatusNotifier extends StateNotifier<HealthState> {
           'health_score': state.score,
           'health_status': state.status.index,
           'last_activity': state.currentActivity,
+          'is_verifying': state.isVerifying,
           'last_updated': FieldValue.serverTimestamp(),
         }, SetOptions(merge: true));
       }
@@ -315,13 +323,11 @@ class HealthStatusNotifier extends StateNotifier<HealthState> {
     updatedEvents.insert(0, newEvent);
 
     if (activity == 'falling' || activity == 'near_fall') {
-      final penalty = activity == 'falling' ? 600 : 200;
-      final newScore = (state.score - penalty).clamp(0, 1000);
+      // Do not deduct score immediately. Wait for AI verification.
       state = state.copyWith(
-        score: newScore,
         currentActivity: activity,
-        status: _getStatus(newScore),
         events: updatedEvents,
+        isVerifying: true,
       );
       
       // Trigger Cloud Verification and Sync
@@ -379,13 +385,16 @@ class HealthStatusNotifier extends StateNotifier<HealthState> {
       if (isVerified) {
         debugPrint("Event ${event.id} verified with confidence: $confidence");
         
+        final penalty = event.type == 'falling' ? 600 : 200;
+        final newScore = (state.score - penalty).clamp(0, 1000);
+        
         // Update event in list
         final updatedEvents = state.events.map((e) {
           if (e.id == event.id) {
             final updated = e.copyWith(
               isVerified: true,
               confidence: confidence,
-              description: "${e.description} (Verified)",
+              description: "${e.description} (Verified by AI)",
             );
             // Sync verified status to Firestore
             _eventRepository.syncEvent(updated);
@@ -394,11 +403,33 @@ class HealthStatusNotifier extends StateNotifier<HealthState> {
           return e;
         }).toList();
         
-        state = state.copyWith(events: updatedEvents);
+        state = state.copyWith(
+          events: updatedEvents,
+          score: newScore,
+          status: HealthStatus.emergency,
+          isVerifying: false,
+        );
+        _saveState();
+
+        // Trigger Critical Notification
+        final user = FirebaseAuth.instance.currentUser;
+        if (user != null) {
+           await FirebaseFirestore.instance.collection('users').doc(user.uid).collection('notifications').add({
+              'title': 'Critical Event Detected',
+              'message': 'AI verified a potential ${event.type}. Please check immediately.',
+              'type': 'danger', // maps to NotificationType.danger
+              'date': FieldValue.serverTimestamp(),
+           });
+        }
+      } else {
+        debugPrint("Event ${event.id} was NOT verified (False Positive)");
+        state = state.copyWith(isVerifying: false);
         _saveState();
       }
     } catch (e) {
       debugPrint("Verification failed: $e");
+      state = state.copyWith(isVerifying: false);
+      _saveState();
     }
   }
 
diff --git a/lib/src/features/pose_detection/data/pose_detection_service.dart b/lib/src/features/pose_detection/data/pose_detection_service.dart
index 0bf7b0c..f868814 100644
--- a/lib/src/features/pose_detection/data/pose_detection_service.dart
+++ b/lib/src/features/pose_detection/data/pose_detection_service.dart
@@ -307,9 +307,9 @@ class PoseDetectionService {
       }
     }
     
-    // Fall: Downward speed > 1.5 body heights/sec OR Impact > 6 body heights/sec^2
+    // Fall: Downward speed > 1.2 body heights/sec OR Impact > 5 body heights/sec^2
     // Reduced impact threshold slightly to be more sensitive to sudden stops
-    return maxDownVel > (height * 1.5) || maxAcc > (height * 6.0);
+    return maxDownVel > (height * 1.2) || maxAcc > (height * 5.0);
   }
 
   double _getBodyHeight(Map<PoseLandmarkType, PoseLandmark> landmarks) {
diff --git a/pubspec.lock b/pubspec.lock
index 9da4059..ab2d571 100644
--- a/pubspec.lock
+++ b/pubspec.lock
@@ -45,10 +45,10 @@ packages:
     dependency: transitive
     description:
       name: characters
-      sha256: faf38497bda5ead2a8c7615f4f7939df04333478bf32e4173fcb06d428b5716b
+      sha256: f71061c654a3380576a52b451dd5532377954cf9dbd272a78fc8479606670803
       url: "https://pub.dev"
     source: hosted
-    version: "1.4.1"
+    version: "1.4.0"
   checked_yaml:
     dependency: transitive
     description:
@@ -724,18 +724,18 @@ packages:
     dependency: transitive
     description:
       name: matcher
-      sha256: "12956d0ad8390bbcc63ca2e1469c0619946ccb52809807067a7020d57e647aa6"
+      sha256: dc58c723c3c24bf8d3e2d3ad3f2f9d7bd9cf43ec6feaa64181775e60190153f2
       url: "https://pub.dev"
     source: hosted
-    version: "0.12.18"
+    version: "0.12.17"
   material_color_utilities:
     dependency: transitive
     description:
       name: material_color_utilities
-      sha256: "9c337007e82b1889149c82ed242ed1cb24a66044e30979c44912381e9be4c48b"
+      sha256: f7142bb1154231d7ea5f96bc7bde4bda2a0945d2806bb11670e30b850d56bdec
       url: "https://pub.dev"
     source: hosted
-    version: "0.13.0"
+    version: "0.11.1"
   meta:
     dependency: transitive
     description:
@@ -1089,10 +1089,10 @@ packages:
     dependency: transitive
     description:
       name: test_api
-      sha256: "93167629bfc610f71560ab9312acdda4959de4df6fac7492c89ff0d3886f6636"
+      sha256: ab2726c1a94d3176a45960b6234466ec367179b87dd74f1611adb1f3b5fb9d55
       url: "https://pub.dev"
     source: hosted
-    version: "0.7.9"
+    version: "0.7.7"
   typed_data:
     dependency: transitive
     description:
diff --git a/test/pose_detection_service_test.dart b/test/pose_detection_service_test.dart
index 1b5996e..535458d 100644
--- a/test/pose_detection_service_test.dart
+++ b/test/pose_detection_service_test.dart
@@ -1,6 +1,7 @@
 import 'package:flutter_test/flutter_test.dart';
 import 'package:lifeguardian/src/features/pose_detection/data/pose_detection_service.dart';
 import 'package:lifeguardian/src/features/pose_detection/data/pose_models.dart';
+import 'package:lifeguardian/src/features/pose_detection/logic/physics_engine.dart';
 
 // Mock Landmark for testing
 class MockPoseLandmark implements PoseLandmark {
@@ -76,5 +77,31 @@ void main() {
       final angle = service.getTorsoAngle(landmarks);
       expect(angle, lessThan(25));
     });
+
+    test('isFalling triggers accurately based on tuned threshold', () {
+      final landmarks = {
+        PoseLandmarkType.nose: MockPoseLandmark(type: PoseLandmarkType.nose, x: 50, y: 10),
+        PoseLandmarkType.leftAnkle: MockPoseLandmark(type: PoseLandmarkType.leftAnkle, x: 50, y: 110),
+        PoseLandmarkType.rightAnkle: MockPoseLandmark(type: PoseLandmarkType.rightAnkle, x: 50, y: 110),
+      }; // Height approx 100
+
+      final person = TrackedPerson(0, landmarks);
+      // Downward velocity > 1.2 * height (120) or maxAcc > 5.0 * height (500)
+      person.landmarkPhysics[PoseLandmarkType.leftHip] = PhysicsData(
+        vy: 130, // threshold is 120
+        acceleration: 100,
+      );
+
+      final isFalling = service.isFalling(person);
+      expect(isFalling, isTrue);
+
+      // Under threshold
+      person.landmarkPhysics[PoseLandmarkType.leftHip] = PhysicsData(
+        vy: 100, // under 120
+        acceleration: 400, // under 500
+      );
+      final isNotFalling = service.isFalling(person);
+      expect(isNotFalling, isFalse);
+    });
   });
 }
-- 
2.50.1 (Apple Git-155)

